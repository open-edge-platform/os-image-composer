# AI-searchable metadata for template discovery
metadata:
  description: "Edge Microvisor Toolkit 3 Edge Multifunction Real-Time (EMF-RT) raw image with real-time kernel for time-sensitive edge workloads"
  use_cases:
    - "real-time edge"
    - "industrial automation"
    - "time-sensitive networking"
    - "deterministic computing"
  keywords:
    - emf
    - realtime
    - rt
    - edge
    - industrial
    - automation
    - emt3
    - microvisor
    - deterministic

image:
  name: emt3-x86_64-minimal-ptl-emf-rt
  version: "1.0.0"

target:
  os: edge-microvisor-toolkit # Target OS name
  dist: emt3 # Target OS distribution
  arch: x86_64 # Target OS architecture
  imageType: raw # Image type, valid value: [raw, iso].

packageRepositories:
  - codename: "emtNext"
    url: "https://files-rs.edgeorchestration.intel.com/files-edge-orch/microvisor/rpms/next/base"
    pkey: "https://raw.githubusercontent.com/open-edge-platform/edge-microvisor-toolkit/refs/heads/3.0/SPECS/edge-repos/INTEL-RPM-GPG-KEY"
    # list of allowed packages from this repository
    allowPackages:
      - kernel-6.17.11
      - kernel-drivers-gpu-6.17.11
      - gstreamer1-plugins-base
      - spice-server
      - spice-protocol
      - busybox
      - ethtool
      - iperf3
      - msr-tools
      - lsscsi
      - tpm2-abrmd
      - binutils
      - cifs-utils
      - opencl-headers
      - linuxptp
      - libva-utils
      - pulseaudio
      - libsndfile
      # Dependencies for gstreamer1-plugins-base
      - libvorbis
      - libvisual
      - libtheora
      - orc
      - libogg
      - graphene
      - iso-codes
      - libcdda_interface0
      - libcdda_paranoia0
      # Dependencies for spice-server
      - opus
      # libepoxy and QEMU graphics dependencies
      - libepoxy
      - qemu
      - qemu-common
      - qemu-user
      - qemu-img
      - qemu-tools
      - qemu-system-aarch64
      - qemu-system-arm
      - qemu-system-riscv
      - qemu-system-x86-core
      - qemu-audio-spice
      - qemu-char-spice
      - qemu-device-display-qxl
      - qemu-ui-opengl
      - qemu-ui-spice-app
      - qemu-ui-spice-core
      # Packages aligned with installer script
      - gdb
      - ovmf
      - openbox
      - libpng-devel
      - libXinerama-devel
      - libXrandr-devel
      - libXt-devel
      - libXcursor-devel
      - libxml2-devel
      - pango-devel
      - freefont
      - xorg-x11-xkb-utils
      - xorg-x11-server-utils
      - xorg-x11-apps
      - dracut-virtio
      - qemu-guest-agent
      - qemu-audio-pa
      - qemu-with-ui
      - qemu-kvm
      - qemu-system-x86
      - qemu-ui-curses
      - qemu-device-usb-redirect
      - qemu-device-usb-host
      - qemu-device-display-virtio-vga
      - qemu-device-display-virtio-gpu-pci
      - qemu-device-display-virtio-gpu-ccw
      - qemu-device-display-virtio-gpu
      - qemu-block-nfs
      - qemu-block-iscsi
      - qemu-block-dmg
      - qemu-block-curl
      - qemu-audio-oss
      - qemu-audio-alsa
      - qemu-ui-gtk
      - qemu-ui-egl-headless
      - qemu-ipxe
      - libvirt
      - swtpm-tools
      - dmidecode
      - cvt
      - xorg-x11-xinit
      - unzip
      - alsa-lib
      - libvpl
      - wayland*
      - tpm2-tools
      - i2c-tools
      - mesa-filesystem
      - mesa-demos
      - mesa-libgbm
      - mesa-libEGL-devel
      - mesa-libGL-devel
      - alsa-utils
      - libva*
      - intel-lms
      - xorg-x11-server-Xorg
      - intel-opencl
      - ocl-icd
      - clinfo
      - kernel-rt-drivers-sound
  - codename: "edgeai"
    url: "https://yum.repos.intel.com/edgeai/"
    pkey: "https://yum.repos.intel.com/edgeai/GPG-PUB-KEY-INTEL-DLS.gpg"

disk:
  name: edge-rt # 1:1 mapping to the systemConfigs name
  artifacts:
    -
      type: raw  # image file format, valid value [raw, vhd, vhdx, qcow2, vmdk, vdi]
      compression: gz # image compression format (optional)
  size: 37376MiB # 4G, 4GB, 4096 MiB also valid. (Required for raw)
  partitionTableType: gpt # Partition table type, valid value: [gpt, mbr]
  partitions: # Required for raw, optional for ISO, not needed for rootfs.
    - id: boot
      type: esp
      flags:
        - esp
        - boot
      start: 1MiB
      end: 384MiB
      fsType: fat32
      mountPoint: /boot/efi
      mountOptions: umask=0077

    - id: rootfs
      type: linux-root-amd64
      start: 384MiB
      end: 8192MiB
      fsType: ext4
      mountPoint: /
      mountOptions: defaults

    - id: edge_persistent
      type: linux
      start: 8192MiB
      end: 16896MiB
      fsType: ext4
      mountPoint: /opt

    - id: swap
      type: linux-swap
      start: 16896MiB
      end: "0"  # use the rest of the disk space
      fsType: linux-swap

systemConfig:

  additionalFiles:
    - local: ../additionalfiles/layout.env
      final: /etc/layout.env

  name: edge-rt
  description: Default yml configuration for raw image

  immutability:
    enabled: false # default is true
    # To enable Secure Boot, provide the actual file paths for your environment below and uncomment the relevant lines.
    # secureBootDBKey: "<SECURE_BOOT_DB_KEY_PATH>"
    # secureBootDBCrt: "<SECURE_BOOT_DB_CRT_PATH>"
    # secureBootDBCer: "<SECURE_BOOT_DB_CER_PATH>"

    # Package Configuration
  packages:
    # Additional packages beyond the base system
    - tpm-cryptsetup
    - persistent-mount
    - intel-npu-driver
    - busybox
    - ethtool
    - iperf3
    - msr-tools
    - lsscsi
    - tpm2-abrmd
    - binutils
    - cifs-utils
    - opencl-headers
    - linuxptp
    - libva-utils
    - pulseaudio
    - libsndfile
    # Development tools
    - perl
    - gcc
    - gcc-c++
    - make
    # QEMU full system emulation
    - qemu
    - qemu-user
    - qemu-img 
    - qemu-tools
    - qemu-system-aarch64
    - qemu-system-arm
    - qemu-system-riscv
    - qemu-system-x86
    # Graphics and display stack
    - mesa-dri-drivers
    - mesa-libGL
    - mesa-libEGL
    - libX11
    - libepoxy
    - libwayland-client
    - cairo
    - pango
    - freetype
    - fontconfig
    # Multimedia
    - gstreamer1
    - gstreamer1-plugins-base
    # Container runtime
    - containerd2
    - containerd2-core
    # Additional tools
    - helm
    - intel-level-zero-zello_world
    - lm-sensors
    - llvm
    - spice-server
    - spice-protocol
    # installer_emt.sh package set
    - gdb
    - edk2-ovmf
    - openbox
    - libpng-devel
    - libXinerama-devel
    - libXrandr-devel
    - libXt-devel
    - libXcursor-devel
    - libxml2-devel
    - pango-devel
    - freefont
    - xorg-x11-xkb-utils
    - xorg-x11-server-utils
    - xorg-x11-apps
    - dracut-virtio
    - qemu-guest-agent
    - qemu-audio-pa
    - qemu-with-ui
    - qemu-kvm
    - libvirt
    - swtpm-tools
    - dmidecode
    - cvt
    - xorg-x11-xinit
    - unzip
    - alsa-lib
    - libvpl
    - wayland*
    - tpm2-tools
    - i2c-tools
    - mesa-filesystem
    - mesa-demos
    - mesa-libgbm
    - mesa-libEGL-devel
    - mesa-libGL-devel
    - alsa-utils
    - libva*
    - intel-lms
    - xorg-x11-server-Xorg
    - intel-opencl
    - ocl-icd
    - clinfo
    - kernel-rt-drivers-sound
    - intel-dlstreamer

  # Kernel Configuration
  kernel:
    version: "6.17"
    cmdline: "modprobe.blacklist=i915 processor.max_cstate=0 intel.max_cstate=0 processor_idle.max_cstate=0 intel_idle.max_cstate=0 clocksource=tsc tsc=reliable nowatchdog intel_pstate=disable idle=poll nosmt isolcpus=2,3 rcu_nocbs=2,3 rcupdate.rcu_cpu_stall_suppress=1 rcu_nocb_poll irqaffinity=0 mce=off hpet=disable numa_balancing=disable igb.blacklist=no nmi_watchdog=0 nosoftlockup"
    enableExtraModules: "intel_vpu uas"
    packages:
      - kernel-rt-drivers-gpu

  configurations:
    - cmd: "echo 'user ALL=(ALL) NOPASSWD: ALL' > /etc/sudoers.d/user-sudo"
    - cmd: "chmod 440 /etc/sudoers.d/user-sudo"
    - cmd: "grep -q '^http_proxy=http://proxy-dmz.intel.com:911$' /etc/environment || echo 'http_proxy=http://proxy-dmz.intel.com:911' >> /etc/environment"
    - cmd: "grep -q '^https_proxy=http://proxy-dmz.intel.com:912$' /etc/environment || echo 'https_proxy=http://proxy-dmz.intel.com:912' >> /etc/environment"
    - cmd: "grep -q '^ftp_proxy=http://proxy-dmz.intel.com:911$' /etc/environment || echo 'ftp_proxy=http://proxy-dmz.intel.com:911' >> /etc/environment"
    - cmd: "grep -q '^socks_server=http://proxy-dmz.intel.com:1080$' /etc/environment || echo 'socks_server=http://proxy-dmz.intel.com:1080' >> /etc/environment"
    - cmd: "grep -q '^no_proxy=.internal,10.*,10.0.0.0/8,127.0.0.1,169.254.169.254,::1,localhost,10.49.76.92$' /etc/environment || echo 'no_proxy=.internal,10.*,10.0.0.0/8,127.0.0.1,169.254.169.254,::1,localhost,10.49.76.92' >> /etc/environment"
    - cmd: "grep -q '^no_proxy=localhost,127.0.0.1,127.0.1.1,127.0.0.0/8,172.16.0.0/20,192.168.0.0/16,10.0.0.0/8,10.1.0.0/16,10.152.183.0/24,devtools.intel.com,jf.intel.com,teamcity-or.intel.com,caas.intel.com,inn.intel.com,isscorp.intel.com,gfx-assets.fm.intel.com$' /etc/environment || echo 'no_proxy=localhost,127.0.0.1,127.0.1.1,127.0.0.0/8,172.16.0.0/20,192.168.0.0/16,10.0.0.0/8,10.1.0.0/16,10.152.183.0/24,devtools.intel.com,jf.intel.com,teamcity-or.intel.com,caas.intel.com,inn.intel.com,isscorp.intel.com,gfx-assets.fm.intel.com' >> /etc/environment"
    - cmd: "grep -q '^http_proxy = http://proxy-dmz.intel.com:911$' /etc/wgetrc || echo 'http_proxy = http://proxy-dmz.intel.com:911' >> /etc/wgetrc"
    - cmd: "grep -q '^https_proxy = http://proxy-dmz.intel.com:912$' /etc/wgetrc || echo 'https_proxy = http://proxy-dmz.intel.com:912' >> /etc/wgetrc"

