# Robotics AI Suite: Stationary Robot Vision & Control Image Template
# Ubuntu 24.04 LTS + ROS2 Jazzy
#
# This template creates a ready-to-deploy OS image for Stationary Robot
# Vision & Control systems (pick-and-place, track-and-place, inspection).
#
# Components included:
#   - ROS2 Jazzy with MoveIt2 motion planning
#   - OpenVINO with vision models (YOLO, SAM, DETR)
#   - Intel RealSense camera support
#   - Robot arm controllers (UR, Robotiq gripper)
#   - Intel GPU/NPU acceleration
#   - Visual servoing capabilities
#
# Target use cases:
#   - Industrial pick-and-place
#   - Track-and-place operations
#   - Quality inspection systems
#   - Assembly line robotics
#
# Usage:
#   sudo ./os-image-composer build -t image-templates/robotics-vision-ubuntu24-x86_64.yml

image:
  name: robotics-vision-ubuntu24
  version: "24.04"

target:
  os: ubuntu
  dist: ubuntu24
  arch: x86_64
  imageType: raw

packageRepositories:
  # ROS2 Jazzy repository
  - codename: "noble"
    url: "http://packages.ros.org/ros2/ubuntu"
    pkey: "https://raw.githubusercontent.com/ros/rosdistro/master/ros.key"
    component: "main"

  # Intel oneAPI repository
  - codename: "all"
    url: "https://apt.repos.intel.com/oneapi"
    pkey: "https://apt.repos.intel.com/intel-gpg-keys/GPG-PUB-KEY-INTEL-SW-PRODUCTS.PUB"
    component: "main"

  # Intel OpenVINO repository
  - codename: "ubuntu24"
    url: "https://apt.repos.intel.com/openvino/2024"
    pkey: "https://apt.repos.intel.com/intel-gpg-keys/GPG-PUB-KEY-INTEL-SW-PRODUCTS.PUB"
    component: "main"

  # Intel Graphics repository (GPU drivers)
  - codename: "noble"
    url: "https://repositories.intel.com/gpu/ubuntu"
    pkey: "https://repositories.intel.com/gpu/intel-graphics.key"
    component: "unified"

systemConfig:
  name: robotics-vision
  description: Intel Robotics AI Suite - Stationary Robot Vision & Control with ROS2 Jazzy

  immutability:
    enabled: false  # Set to true for production deployment

  packages:
    # Base system
    - ubuntu-minimal
    - systemd
    - systemd-resolved
    - openssh-server
    - network-manager
    - sudo
    - curl
    - wget
    - git
    - vim
    - htop

    # Build essentials
    - build-essential
    - cmake
    - python3-pip
    - python3-venv
    - python3-colcon-common-extensions

    # ROS2 Jazzy Core
    - ros-jazzy-ros-base
    - ros-jazzy-rmw-cyclonedds-cpp
    - ros-jazzy-ros-dev-tools

    # MoveIt2 Motion Planning
    - ros-jazzy-moveit
    - ros-jazzy-moveit-ros-planning
    - ros-jazzy-moveit-ros-planning-interface
    - ros-jazzy-moveit-ros-visualization
    - ros-jazzy-moveit-servo
    - ros-jazzy-moveit-msgs

    # Robot Controllers
    - ros-jazzy-controller-manager
    - ros-jazzy-control-toolbox
    - ros-jazzy-joint-state-broadcaster
    - ros-jazzy-joint-trajectory-controller
    - ros-jazzy-joint-state-publisher
    - ros-jazzy-velocity-controllers
    - ros-jazzy-position-controllers
    - ros-jazzy-forward-command-controller

    # ROS2 Transforms and Utilities
    - ros-jazzy-tf2
    - ros-jazzy-tf2-ros
    - ros-jazzy-tf2-geometry-msgs
    - ros-jazzy-tf2-eigen
    - ros-jazzy-tf2-sensor-msgs
    - ros-jazzy-xacro

    # ROS2 Visualization
    - ros-jazzy-rviz2
    - ros-jazzy-rviz-common
    - ros-jazzy-rviz-default-plugins
    - ros-jazzy-rviz-rendering

    # Intel RealSense Camera Support
    - ros-jazzy-librealsense2
    - ros-jazzy-realsense2-camera
    - ros-jazzy-realsense2-description
    - ros-jazzy-realsense2-camera-msgs
    - ros-jazzy-depth-image-proc
    - ros-jazzy-image-transport
    - ros-jazzy-compressed-image-transport
    - ros-jazzy-compressed-depth-image-transport
    - ros-jazzy-image-transport-plugins

    # Intel OpenVINO for AI Inference
    - ros-jazzy-openvino-node
    - openvino
    - openvino-libraries-dev

    # Point Cloud Processing
    - ros-jazzy-pcl-conversions
    - ros-jazzy-pcl-ros
    - libpcl-dev

    # Intel GPU/Compute Support
    - intel-opencl-icd
    - intel-level-zero-gpu
    - level-zero

    # Message filters and communication
    - ros-jazzy-message-filters
    - ros-jazzy-sensor-msgs
    - ros-jazzy-geometry-msgs
    - ros-jazzy-visualization-msgs
    - ros-jazzy-std-srvs
    - ros-jazzy-diagnostic-updater

    # Hardware interface
    - ros-jazzy-hardware-interface
    - ros-jazzy-pluginlib
    - ros-jazzy-rclcpp-components
    - ros-jazzy-class-loader

    # Math and optimization libraries
    - libeigen3-dev
    - libopencv-dev
    - libyaml-cpp-dev
    - libnlopt-dev
    - libnlopt-cxx-dev
    - nlohmann-json3-dev
    - libboost-serialization-dev

    # Python ML dependencies
    - python3-opencv
    - python3-numpy
    - python3-scipy

  kernel:
    version: "6.14"
    cmdline: "console=ttyS0,115200 console=tty0 loglevel=7"
    packages:
      - linux-image-generic-hwe-24.04

  configurations:
    # ROS2 environment setup
    - cmd: "echo 'source /opt/ros/jazzy/setup.bash' >> /etc/bash.bashrc"
    - cmd: "echo 'export RMW_IMPLEMENTATION=rmw_cyclonedds_cpp' >> /etc/bash.bashrc"

    # Create ROS data directories
    - cmd: "mkdir -p /opt/ros-data/log"
    - cmd: "mkdir -p /opt/ros-data/models"
    - cmd: "mkdir -p /opt/ros-data/calibration"
    - cmd: "mkdir -p /opt/ros-data/tmp"
    - cmd: "chmod -R 777 /opt/ros-data"

    # Environment variables
    - cmd: "echo 'ROS_HOME=/opt/ros-data' >> /etc/environment"
    - cmd: "echo 'ROS_LOG_DIR=/opt/ros-data/log' >> /etc/environment"
    - cmd: "echo 'TMPDIR=/opt/ros-data/tmp' >> /etc/environment"
    - cmd: "echo 'RMW_IMPLEMENTATION=rmw_cyclonedds_cpp' >> /etc/environment"

    # Intel OpenVINO environment
    - cmd: "echo 'source /opt/intel/openvino/setupvars.sh 2>/dev/null || true' >> /etc/bash.bashrc"

    # Intel GPU environment
    - cmd: "echo 'export LD_LIBRARY_PATH=/opt/intel/oneapi/lib:$LD_LIBRARY_PATH' >> /etc/bash.bashrc"

    # Enable services
    - cmd: "systemctl enable NetworkManager"
    - cmd: "systemctl enable ssh"

    # Create robotics user group
    - cmd: "groupadd -f robotics"

    # RealSense camera udev rules
    - cmd: "mkdir -p /etc/udev/rules.d"
    - cmd: |
        echo 'SUBSYSTEM=="usb", ATTRS{idVendor}=="8086", MODE="0666", GROUP="robotics"' > /etc/udev/rules.d/99-realsense.rules

    # Industrial robot controller access (common USB/Serial devices)
    - cmd: |
        echo 'SUBSYSTEM=="tty", MODE="0666", GROUP="robotics"' >> /etc/udev/rules.d/99-robot-controllers.rules
