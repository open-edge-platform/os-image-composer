# Robotics AI Suite: AMR Image Template (Basic - No Intel Repos)
# Ubuntu 24.04 LTS + ROS2 Jazzy
#
# This is a simplified template without Intel-specific repositories.
# Use this for testing or when Intel repositories are not accessible.
# For full functionality, use robotics-amr-ubuntu24-x86_64.yml with
# proper network access to Intel APT repositories.
#
# Usage:
#   sudo ./os-image-composer build -t image-templates/robotics-amr-basic-ubuntu24-x86_64.yml

image:
  name: robotics-amr-basic-ubuntu24
  version: "24.04"

target:
  os: ubuntu
  dist: ubuntu24
  arch: x86_64
  imageType: raw

# Disk configuration - larger for ROS2 packages
disk:
  name: robotics-amr-basic
  artifacts:
    - type: raw
      compression: gz
  size: 12GiB
  partitionTableType: gpt
  partitions:
    - id: boot
      type: esp
      flags:
        - esp
        - boot
      start: 1MiB
      end: 513MiB
      fsType: fat32
      mountPoint: /boot/efi
      mountOptions: umask=0077
    - id: rootfs
      type: linux-root-amd64
      start: 513MiB
      end: "0"  # Use all remaining space for rootfs
      fsType: ext4
      mountPoint: /
      mountOptions: defaults

packageRepositories:
  # ROS2 Jazzy repository
  - codename: "noble"
    url: "http://packages.ros.org/ros2/ubuntu"
    pkey: "https://raw.githubusercontent.com/ros/rosdistro/master/ros.key"
    component: "main"

systemConfig:
  name: robotics-amr-basic
  description: Intel Robotics AI Suite - AMR Basic (ROS2 Jazzy only)

  immutability:
    enabled: false

  packages:
    # Base system
    - ubuntu-minimal
    - systemd
    - systemd-resolved
    - systemd-boot
    - openssh-server
    - network-manager
    - sudo
    - curl
    - wget
    - git
    - vim
    - htop

    # Boot/initramfs (required for UKI)
    - dracut-core
    - cryptsetup-bin

    # Build essentials
    - build-essential
    - cmake
    - python3-pip
    - python3-venv
    - python3-colcon-common-extensions

    # ROS2 Jazzy Core
    - ros-jazzy-ros-base
    - ros-jazzy-rmw-cyclonedds-cpp
    # ros-dev-tools is provided by python3-colcon-* packages already included

    # ROS2 Navigation Stack (core packages only)
    - ros-jazzy-navigation2
    - ros-jazzy-nav2-msgs
    #- ros-jazzy-slam-toolbox  # Has complex deps

    # ROS2 Transforms and Utilities
    - ros-jazzy-tf2
    - ros-jazzy-tf2-ros
    - ros-jazzy-tf2-geometry-msgs
    - ros-jazzy-xacro

    # ROS2 Visualization
    #- ros-jazzy-rviz2  # Has complex deps

    # Point Cloud Processing
    #- ros-jazzy-pcl-conversions  # Has complex deps 
    #- libpcl-dev

    # Sensor and message types
    - ros-jazzy-sensor-msgs
    - ros-jazzy-geometry-msgs
    - ros-jazzy-visualization-msgs
    - ros-jazzy-diagnostic-updater

    # Math libraries
    - libeigen3-dev
    #- libopencv-dev  # Has complex deps
    - libyaml-cpp-dev

  kernel:
    version: "6.14"
    cmdline: "console=ttyS0,115200 console=tty0 loglevel=7"
    packages:
      - linux-image-generic-hwe-24.04

  configurations:
    # ROS2 environment setup
    - cmd: "echo 'source /opt/ros/jazzy/setup.bash' >> /etc/bash.bashrc"
    - cmd: "echo 'export RMW_IMPLEMENTATION=rmw_cyclonedds_cpp' >> /etc/bash.bashrc"

    # Create ROS data directories
    - cmd: "mkdir -p /opt/ros-data/log"
    - cmd: "mkdir -p /opt/ros-data/maps"
    - cmd: "mkdir -p /opt/ros-data/tmp"
    - cmd: "chmod -R 777 /opt/ros-data"

    # Environment variables
    - cmd: "echo 'ROS_HOME=/opt/ros-data' >> /etc/environment"
    - cmd: "echo 'ROS_LOG_DIR=/opt/ros-data/log' >> /etc/environment"
    - cmd: "echo 'RMW_IMPLEMENTATION=rmw_cyclonedds_cpp' >> /etc/environment"

    # Enable services
    - cmd: "systemctl enable NetworkManager"
    - cmd: "systemctl enable ssh"
